---
import Logo from "../assets/Logo/lOGOPNG (1).svg";
import { Image } from "astro:assets";
import { ruta } from "./Welcome.astro";
---

<nav class="relative border-2 rounded-lg shadow-md shadow-black px-4 py-2">
  <!-- Contenedor de botones alineados a la derecha -->
  <div
    class="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col md:flex-row gap-2 md:gap-4 items-end md:items-center"
  >
    <button class="px-4 py-2 uppercase">BLOG</button>
    <button class="md:px-4 md:py-2 py-0 px-0 uppercase" id="btnIniciar"
      >Inicia sesión</button
    >
  </div>

  <!-- Imagen centrada -->
  <div class="flex justify-center">
    <Image
      src={Logo}
      alt="Logo"
      class="md:w-50 md:h-50 h-20 w-20"
      priority={true}
    />
  </div>

  <!-- Menú desplegable de inicio de sesión -->
  <div
    id="loginDropdown"
    class="hidden fixed top-0 left-0 w-full h-full bg-opacity-40 backdrop-blur-md flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-lg shadow-lg w-full max-w-xs p-6 relative">
      <button
        id="closeLogin"
        class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-xl"
        >&times;</button
      >
      <!-- Formulario de login -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label
            for="loginEmail"
            class="block text-sm font-semibold text-gray-700"
            >Correo electrónico</label
          >
          <input
            type="email"
            id="loginEmail"
            required
            class="mt-1 w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#ff5a5f]"
            placeholder="usuario@correo.com"
          />
        </div>
        <div>
          <label
            for="loginPassword"
            class="block text-sm font-semibold text-gray-700">Contraseña</label
          >
          <input
            type="password"
            id="loginPassword"
            required
            class="mt-1 w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#ff5a5f]"
            placeholder="********"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-[#ff5a5f] text-white font-bold py-2 rounded hover:bg-[#e04e52] transition"
          >Ingresar</button
        >
      </form>
      <div class="mt-4 text-center">
        <button id="showForgot" class="text-[#000000] hover:underline text-sm"
          >Olvidé la contraseña</button
        >
      </div>
      <!-- Formulario de recuperación -->
      <form id="forgotForm" class="space-y-4 hidden mt-2">
        <div>
          <label
            for="forgotEmail"
            class="block text-sm font-semibold text-gray-700"
            >Introduce tu correo para restablecer</label
          >
          <input
            type="email"
            id="forgotEmail"
            required
            class="mt-1 w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-[#ff5a5f]"
            placeholder="usuario@correo.com"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-[#ff5a5f] text-white font-bold py-2 rounded hover:bg-[#e04e52] transition"
          >Enviar enlace</button
        >
        <button
          type="button"
          id="backToLogin"
          class="w-full mt-2 text-gray-500 hover:underline text-xs"
          >Volver al inicio de sesión</button
        >
      </form>
    </div>
  </div>
</nav>

<script>
  //modal
  document.addEventListener("DOMContentLoaded", function () {
    const btnIniciar = document.getElementById("btnIniciar");
    const loginDropdown = document.getElementById("loginDropdown");
    const closeLogin = document.getElementById("closeLogin");
    const showForgot = document.getElementById("showForgot");
    const forgotForm = document.getElementById("forgotForm");
    const loginForm = document.getElementById("loginForm");
    const backToLogin = document.getElementById("backToLogin");
    // Mostrar menú login
    btnIniciar.addEventListener("click", function () {
      loginDropdown.classList.remove("hidden");
    });
    // Cerrar menú login
    closeLogin.addEventListener("click", function () {
      loginDropdown.classList.add("hidden");
      // Siempre mostrar loginForm y ocultar forgotForm al cerrar
      loginForm.classList.remove("hidden");
      forgotForm.classList.add("hidden");
    });
    // Mostrar formulario de recuperación
    showForgot.addEventListener("click", function () {
      loginForm.classList.add("hidden");
      forgotForm.classList.remove("hidden");
    });
    // Volver al login
    backToLogin.addEventListener("click", function () {
      forgotForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
    });
    // Opcional: cerrar con click fuera del modal
    loginDropdown.addEventListener("click", function (e) {
      if (e.target === loginDropdown) {
        loginDropdown.classList.add("hidden");
        loginForm.classList.remove("hidden");
        forgotForm.classList.add("hidden");
      }
    });
  });

  //login
  const formData = document.getElementById("loginForm");
  let formSubmitted = false; // Bandera para controlar envíos
  const correo = document.getElementById("loginEmail");
  const contraseña = document.getElementById("loginPassword");
  const forgotEmail = document.getElementById("forgotEmail");


  if (formData && !formData.dataset.listenerAdded) {
    formData.addEventListener("submit", (e) => {
      e.preventDefault();
      
      fetch(`${ruta}/login`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          correo: correo.value,
          contraseña: contraseña.value,
        }),
      })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          if (data.role === "cliente") {
            location.href = "PrincipalCliente";
          } else {
            location.href = "RegNegocio";
          }
        } else {
          alert(data.message);
        }
      })
      .catch((err) => {
        console.error(err);
        alert("Error al enviar el formulario");
      })
      .finally(() => {
        formSubmitted = false;
      });
      
      
    });
    formSubmitted = true;
  }
</script>
