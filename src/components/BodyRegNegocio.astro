---
import Business from "../assets/img/Business.svg";
---

<div class="align-center text-center justify-center">
    <h1 class="uppercase text-5xl m-5">Registro de negocio</h1>
</div>

<div class="container mx-auto">
    <div
        class="flex flex-col-reverse lg:flex-row bg-white rounded-2xl shadow-lg overflow-hidden"
        id="registroNegocio"
    >
        <!-- Imagen -->
        <div class="lg:w-1/2">
            <img
                src={Business.src}
                alt="Registro"
                class="w-full h-full object-contain"
            />
        </div>

        <!-- Formulario -->
        <div class="lg:w-1/2 p-8 space-y-6">
            <form class="space-y-4" id="registroNegocio">
                <div>
                    <label
                        for="nombre_establecimiento"
                        class="block text-sm font-medium text-gray-600 uppercase font-[Poppins]"
                        >Nombre del Establecimiento</label
                    >
                    <input
                        id="nombre_establecimiento"
                        type="text"
                        name="nombre_establecimiento"
                        class="mt-1 w-full border rounded-md p-2"
                        required
                    />
                </div>

                <div>
                    <label
                        for="telefono_establecimiento"
                        class="block text-sm font-medium text-gray-600 uppercase font-[Poppins]"
                        >Teléfono</label
                    >
                    <input
                        id="telefono_establecimiento"
                        type="text"
                        name="telefono_establecimiento"
                        class="mt-1 w-full border rounded-md p-2"
                        required
                    />
                </div>

                <div>
                    <label
                        for="direccion"
                        class="block text-sm font-medium text-gray-600 uppercase font-[Poppins]"
                        >Dirección</label
                    >
                    <input
                        id="direccion"
                        type="text"
                        name="direccion"
                        class="mt-1 w-full border rounded-md p-2"
                        required
                    />
                </div>

                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label for="hora_inicio" class="block text-sm font-medium text-gray-600 uppercase font-[Poppins]">
                            Hora Inicio
                        </label>
                        <input 
                            type="time" 
                            id="hora_inicio" 
                            name="hora_inicio"
                            min="06:00" 
                            max="22:00" 
                            step="3600"
                            pattern="[0-9]{2}:00"
                            title="Por favor, seleccione una hora en punto (ej. 06:00, 07:00)"
                            class="mt-1 w-full border rounded-md p-2"
                            required
                        >
                        <p id="hora-error" class="mt-1 text-sm text-red-600 hidden">La hora debe ser en punto (minutos :00)</p>
                    </div>
                    <div class="w-1/2">
                        <label
                            for="hora_fin"
                            class="block text-sm font-medium text-gray-600 uppercase font-[Poppins]"
                            >Hora Fin</label
                        >
                        <input
                            id="hora_fin"
                            type="time"
                            name="hora_fin"
                            min="06:00" 
                            max="22:00"
                            step="3600"
                            pattern="[0-9]{2}:00"
                            title="Por favor, seleccione una hora en punto (ej. 08:00, 22:00)"
                            class="mt-1 w-full border rounded-md p-2"
                            required
                        />
                        <p id="hora-fin-error" class="mt-1 text-sm text-red-600 hidden">La hora final debe ser en punto (minutos :00)</p>
                    </div>
                </div>


                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label
                        for="precio"
                        class="block text-sm font-medium text-gray-600 uppercase font-[Poppins]"
                      >Precio</label>
                      <input
                        id="precio"
                        type="text"
                        name="precio"
                        class="mt-1 w-full border rounded-md p-2"
                        required
                        placeholder="$ 1.000"
                      />
                    </div>
                  
                    <div class="w-1/2">
                      <label class="text-sm font-medium text-gray-600 uppercase font-[Poppins] mb-1">Tipo de servicio</label>
                      <div>
                        <input
                          type="radio"
                          id="barbero"
                          name="tipo_servicio"
                          value="barbero"
                          class="mr-1"
                        />
                        <label for="barbero" class="uppercase font-[Poppins]">BARBERO</label>
                        <br />
                        <input
                          type="radio"
                          id="estilista"
                          name="tipo_servicio"
                          value="estilista"
                          class="mr-1"
                        />
                        <label for="estilista" class="uppercase font-[Poppins]">ESTILISTA FEMENINA</label>
                      </div>
                    </div>
                  </div>
                  

                <div>
                    <span
                        class="block text-sm font-medium text-gray-600 mb-1 uppercase font-[Poppins]"
                        >Días de Trabajo</span
                    >
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <div>
                            <input
                                type="checkbox"
                                id="lunes"
                                name="dias_trabajo"
                                value="Lunes"
                                class="mr-1"
                            />
                            <label for="lunes" class="uppercase font-[Poppins]"
                                >Lunes</label
                            >
                        </div>
                        <div>
                            <input
                                type="checkbox"
                                id="martes"
                                name="dias_trabajo"
                                value="Martes"
                                class="mr-1"
                            />
                            <label for="martes" class="uppercase font-[Poppins]"
                                >Martes</label
                            >
                        </div>
                        <div>
                            <input
                                type="checkbox"
                                id="miercoles"
                                name="dias_trabajo"
                                value="Miércoles"
                                class="mr-1"
                            />
                            <label
                                for="miercoles"
                                class="uppercase font-[Poppins]"
                                >Miércoles</label
                            >
                        </div>
                        <div>
                            <input
                                type="checkbox"
                                id="jueves"
                                name="dias_trabajo"
                                value="Jueves"
                                class="mr-1"
                            />
                            <label for="jueves" class="uppercase font-[Poppins]"
                                >Jueves</label
                            >
                        </div>
                        <div>
                            <input
                                type="checkbox"
                                id="viernes"
                                name="dias_trabajo"
                                value="Viernes"
                                class="mr-1"
                            />
                            <label
                                for="viernes"
                                class="uppercase font-[Poppins]">Viernes</label
                            >
                        </div>
                        <div>
                            <input
                                type="checkbox"
                                id="sabado"
                                name="dias_trabajo"
                                value="Sábado"
                                class="mr-1"
                            />
                            <label for="sabado" class="uppercase font-[Poppins]"
                                >Sábado</label
                            >
                        </div>
                        <div>
                            <input
                                type="checkbox"
                                id="domingo"
                                name="dias_trabajo"
                                value="domingo"
                                class="mr-1"
                            />
                            <label
                                for="domingo"
                                class="uppercase font-[Poppins]">Domingo</label
                            >
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button
                        type="submit"
                        class="w-full bg-black hover:bg-[#e04e52] text-white font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline transition-colors uppercase font-[Poppins]"
                    >
                        Continuar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    import {alertaCheck, alertaCheck3, alertaFallo, alertaMal} from "../assets/Alertas/Alertas.js";
import { animar } from "../assets/Animaciones/animaRegSecion.js";
    import { ruta } from "./Welcome.astro";
    animar();
    //formato cop 
    const precioInput = document.getElementById('precio');

//validar hora-Inicio en 6.00 en rango 
document.getElementById('hora_inicio').addEventListener('change', function() {
        const horaInput = this.value;
        const minutos = horaInput.split(':')[1];
        const errorElement = document.getElementById('hora-error');
        
        if(minutos !== '00') {
            errorElement.classList.remove('hidden');
            this.setCustomValidity('La hora debe ser en punto (minutos :00)');
        } else {
            errorElement.classList.add('hidden');
            this.setCustomValidity('');
        }
    });

    //validar hora-cerrar en 6.00 en rango 

    document.getElementById('hora_fin').addEventListener('change', function() {
        validarHoraEnPunto(this, 'hora-fin-error');
        
        // Opcional: Validar que hora fin sea mayor que hora inicio
        const horaInicio = document.getElementById('hora_inicio').value;
        const horaFin = this.value;
        
        if(horaInicio && horaFin && horaFin <= horaInicio) {
            alert('La hora final debe ser posterior a la hora de inicio');
            this.value = '';
        }
    });

    // Función reutilizable para validar horas en punto
    function validarHoraEnPunto(inputElement, errorElementId) {
        const horaInput = inputElement.value;
        const minutos = horaInput.split(':')[1];
        const errorElement = document.getElementById(errorElementId);
        
        if(minutos !== '00') {
            errorElement.classList.remove('hidden');
            inputElement.setCustomValidity('La hora debe ser en punto (minutos :00)');
        } else {
            errorElement.classList.add('hidden');
            inputElement.setCustomValidity('');
        }
    }




precioInput.addEventListener('input', (e) => {
  // Remueve todo lo que no sea dígito
  let value = e.target.value.replace(/\D/g, '');

  // Limita el número máximo a 100000
  if (Number(value) > 100000) {
    value = '100000';
  }

  // Aplica formato
  const formatter = new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
  });

  if (value) {
    const formatted = formatter.format(Number(value));
    e.target.value = formatted;

    // Si el formateado supera 8 caracteres, recorta
    if (formatted.length > 9) {
      // corta desde el final para conservar los dígitos más significativos
      e.target.value = formatted.slice(0, 9);
    }
  } else {
    e.target.value = '';
  }
});
    //  import {ruta} from "../assets/Animaciones/animaRegSecion.js";
    //envio de datos de negocio
    document
        .getElementById("registroNegocio")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const userid = sessionStorage.getItem("Id");
            const role = sessionStorage.getItem("Role");
            // Capturamos todos los días marcados como array
            const diasSeleccionados = formData.getAll("dias_trabajo");

            // Obtenemos el resto de campos
            const data = {
                nombre_establecimiento: formData.get("nombre_establecimiento"),
                telefono_establecimiento: formData.get("telefono_establecimiento",),
                direccion: formData.get("direccion"),
                hora_inicio: formData.get("hora_inicio"),
                hora_fin: formData.get("hora_fin"),
                dias_trabajo: diasSeleccionados, // ya es un array
                tipo_servicio: formData.get("tipo_servicio"),
                precio: formData.get("precio"),

            };

            //console.log(data);

            fetch(`${ruta}/registroNegocio`, {
                
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ data, userid }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        
                        alertaCheck3("Registro exitoso");
                        
                    } else {
                        alertaFallo(data.message);
                    }
                })
                .catch((err) => {
                  //  console.error(err);
                    alertaFallo("Error al enviar el formulario");
                });
        });
</script>
